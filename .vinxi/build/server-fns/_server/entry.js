import{fromJSON as I,crossSerializeStream as O,getCrossReferenceHeader as W}from"seroval";import{CustomEventPlugin as H,DOMExceptionPlugin as q,EventPlugin as v,FormDataPlugin as x,HeadersPlugin as P,ReadableStreamPlugin as T,RequestPlugin as E,ResponsePlugin as $,URLSearchParamsPlugin as A,URLPlugin as C}from"seroval-plugins/web";import{sharedConfig as F}from"solid-js";import{provideRequestEvent as N}from"solid-js/web/storage";import{H3Event as h,setHeader as B,getRequestURL as D,getRequestIP as M,setResponseStatus as j,getResponseStatus as z,getResponseStatusText as J,getResponseHeaders as G,getResponseHeader as V,setResponseHeader as K,appendResponseHeader as Q,getRequestWebStream as X,removeResponseHeader as Y,eventHandler as Z}from"h3";import{getContext as ee}from"unctx";import{AsyncLocalStorage as te}from"node:async_hooks";const d="Invariant Violation",{setPrototypeOf:se=function(e,t){return e.__proto__=t,e}}=Object;class m extends Error{framesToPop=1;name=d;constructor(t=d){super(typeof t=="number"?`${d}: ${t} (see https://github.com/apollographql/invariant-packages)`:t),se(this,m.prototype)}}function ne(e,t){if(!e)throw new m(t)}function re(e){let t;const s=L(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(s,{...r,body:e.node.req.body}):new Request(s,{...r,get body(){return t||(t=de(e),t)}})}function oe(e){return e.web??={request:re(e),url:L(e)},e.web.request}function ae(){return he()}const R=Symbol("$HTTPEvent");function ie(e){return typeof e=="object"&&(e instanceof h||e?.[R]instanceof h||e?.__is_event__===!0)}function o(e){return function(...t){let s=t[0];if(ie(s))t[0]=s instanceof h||s.__is_event__?s:s[R];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(s=ae(),!s)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");t.unshift(s)}return e(...t)}}const L=o(D),ue=o(M),y=o(j),S=o(z),ce=o(J),l=o(G),b=o(V),pe=o(K),fe=o(Q),_=o(B),de=o(X),le=o(Y);function ge(){return ee("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:te})}function he(){return ge().use().event}const g=Symbol("fetchEvent");function me(e){return{request:oe(e),response:Se(e),clientAddress:ue(e),locals:{},nativeEvent:e,[R]:e}}function Re(e){if(!e[g]){const t=me(e);e[g]=t}return e[g]}function w(e,t){for(const[s,r]of t.entries())_(e,s,r)}class ye{constructor(t){this.event=t}get(t){const s=b(this.event,t);return Array.isArray(s)?s.join(", "):s}has(t){return this.get(t)!==void 0}set(t,s){return pe(this.event,t,s)}delete(t){return le(this.event,t)}append(t,s){fe(this.event,t,s)}getSetCookie(){const t=b(this.event,"Set-Cookie");return Array.isArray(t)?t:[t]}forEach(t){return this.entries().forEach(([s,r])=>t(r,s,this))}entries(){return l(this.event).map(([t,s])=>[t,Array.isArray(s)?s.join(", "):s])}keys(){return l(this.event).map(([t])=>t)}values(){return l(this.event).map(([t,s])=>Array.isArray(s)?s.join(", "):s)}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function Se(e){return{get status(){return S(e)},set status(t){y(e,t)},get statusText(){return ce(e)},set statusText(t){y(e,S(),t)},headers:new ye(e)}}function be(e){const s=e.length.toString(16),r="00000000".substring(0,8-s.length)+s;return new TextEncoder().encode(`;0x${r};${e}`)}function we(e,t){return new ReadableStream({start(s){O(t,{scopeId:e,plugins:[H,q,v,x,P,T,E,$,A,C],onSerialize(r,a){s.enqueue(be(a?`(${W(e)},${r})`:r))},onDone(){s.close()},onError(r){s.error(r)}})}})}async function He(e){const t=Re(e),s=t.request,r=s.headers.get("x-server-id"),a=s.headers.get("x-server-instance"),c=new URL(s.url);let p,f;if(r)ne(typeof r=="string","Invalid server function"),[p,f]=r.split("#");else if(p=c.searchParams.get("id"),f=c.searchParams.get("name"),!p||!f)throw new Error("Invalid request");const k=(await globalThis.MANIFEST["server-fns"].chunks[p].import())[f];let i=[];if(!a||e.method==="GET"){const n=c.searchParams.get("args");n&&JSON.parse(n).forEach(u=>i.push(u))}if(e.method==="POST"){const n=s.headers.get("content-type");if(n.startsWith("multipart/form-data")||n.startsWith("application/x-www-form-urlencoded"))i.push(await new Request(s,{...s,body:e.node.req.body}).formData());else{const u=new Request(s,{...s,body:e.node.req.body});i=I(await u.json(),{plugins:[H,q,v,x,P,T,E,$,A,C]})}}try{let n=await N(t,()=>(F.context={event:t},k(...i)));if(n instanceof Response){if(n.status===302)return new Response(null,{status:a?204:302,headers:{Location:n.headers.get("Location")}});n.headers&&w(e,n.headers),n.customBody?n=await n.customBody():n.body==null&&(n=void 0)}if(!a){const u=n instanceof Error,U=new URL(s.headers.get("referer"));return new Response(null,{status:302,headers:{Location:U.toString(),...n?{"Set-Cookie":`flash=${JSON.stringify({url:c.pathname+encodeURIComponent(c.search),result:u?n.message:n,error:u,input:[...i.slice(0,-1),[...i[i.length-1].entries()]]})}; Secure; HttpOnly;`}:{}}})}return typeof n=="string"?new Response(n):(_(e,"content-type","text/javascript"),we(a,n))}catch(n){if(n instanceof Response){if(n.status===302)return new Response(null,{status:a?204:302,headers:{Location:n.headers.get("Location")}});n.headers&&w(e,n.headers),n.customBody?n=await n.customBody():n.body==null&&(n=void 0)}return n}}const Ae=Z(He);export{Ae as default};
